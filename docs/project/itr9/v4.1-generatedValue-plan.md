# generatedValue 実装計画

**日付**: 2025-12-08
**機能**: LLMによる動的コンテンツ生成（ラベル/サンプルデータ）

---

## 概要

UISpec生成時（第3段階）にWidgetのconfig内にLLM生成コンテンツを含める機能を実装する。

**スコープ**:
- Type A: ラベル・説明文の動的生成（EmotionPalette等）
- Type B: サンプルデータの生成（BrainstormCards等）

**優先Widget**: BrainstormCards（Type B）から実装

---

## 実装ステップ

### Step 1: 仕様書更新（DSL-Spec-v4.0.md）

**ファイル**: `specs/dsl-design/v4/DSL-Spec-v4.0.md`

Section 9 "generatedValue（将来拡張）" を "generatedValue" に変更し、以下を追記:
- GeneratedContentContainer型の定義
- isGeneratedマーカーの説明
- UISpec.config内での使用例

---

### Step 2: バックエンド型定義

**ファイル**: `server/src/types/v4/ui-spec.types.ts`

```typescript
// 追加する型定義
export interface GeneratedSampleItem {
  id: string;
  text: string;
  color?: string;
  isGenerated: true;
  [key: string]: unknown;
}

export interface GeneratedContentContainer<T = GeneratedSampleItem> {
  items: T[];
  isGenerated: true;
}
```

---

### Step 3: Widget定義に生成ヒント追加

**ファイル**: `server/src/types/v4/widget-definition.types.ts`

```typescript
// 追加
export interface WidgetGenerationHints {
  labels?: {
    field: string;
    instruction: string;
    count?: number;
    schema: Record<string, string>;
  };
  samples?: {
    field: string;
    instruction: string;
    count: { min: number; max: number };
    schema: Record<string, string>;
  };
}

// WidgetDefinitionV4に追加
generationHints?: WidgetGenerationHints;
```

**ファイル**: `server/src/definitions/v4/widgets.ts`

BrainstormCardsDefinitionV4（L59）に追加:
```typescript
generationHints: {
  samples: {
    field: 'sampleCards',
    instruction: 'ユーザーの悩みに関連するアイデアの種となるカードを2-3個生成してください。ユーザーの思考を促すきっかけとなる内容にしてください。',
    count: { min: 2, max: 3 },
    schema: { id: 'string', text: 'string', color: 'string (optional)' },
  },
},
```

---

### Step 4: UISpec生成プロンプト更新

**ファイル**: `server/src/prompts/v4/uispec-generation.prompt.ts`

L166以降に追加:

```
### 5. コンテンツ生成（generatedValue）

Widget定義にgenerationHintsがある場合、ユーザーの悩みに関連するコンテンツを生成してください。

**Type B: サンプルデータ**
generationHints.samplesがある場合:
- fieldで指定されたキーにGeneratedContentContainerを配置
- instructionに従い、countで指定された数のアイテムを生成
- 各アイテムにisGenerated: trueを付与
- コンテナにもisGenerated: trueを付与

**例: BrainstormCards**
ユーザーの悩み: 「転職するか迷っている」
→ config.sampleCards:
{
  "items": [
    { "id": "sample_1", "text": "現職のメリット・デメリット", "isGenerated": true },
    { "id": "sample_2", "text": "転職で実現したいこと", "isGenerated": true }
  ],
  "isGenerated": true
}

**重要**:
1. 生成内容はユーザーの具体的な悩みに関連させる
2. サンプルは「考えるきっかけ」であり、完成した答えではない
3. 日本語で生成する
```

---

### Step 5: UISpecGeneratorV4更新

**ファイル**: `server/src/services/v4/UISpecGeneratorV4.ts`

`collectWidgetDefinitions`メソッド（約L135）を更新し、generationHintsを含める:

```typescript
summaries.push({
  id: definition.id,
  name: definition.name,
  // ...既存フィールド
  generationHints: definition.generationHints, // 追加
});
```

---

### Step 6: フロントエンド型定義

**ファイル**: `concern-app/src/types/ui-spec.types.ts`

バックエンドと同じ型を追加:
- `GeneratedSampleItem`
- `GeneratedContentContainer`

---

### Step 7: GeneratedBadgeコンポーネント作成

**新規ファイル**: `concern-app/src/components/ui/GeneratedBadge/`
- `GeneratedBadge.tsx`
- `GeneratedBadge.module.css`
- `index.ts`

```typescript
// GeneratedBadge.tsx
export const GeneratedBadge: React.FC<{ tooltip?: string }> = ({
  tooltip = 'AIが生成したサンプルです'
}) => (
  <span className={styles.badge} title={tooltip}>
    <span className={styles.icon}>✨</span>
    <span className={styles.text}>AI提案</span>
  </span>
);
```

---

### Step 8: BrainstormCardsコンポーネント更新

**ファイル**: `concern-app/src/components/widgets/v3/BrainstormCards/BrainstormCards.tsx`

**変更点**:

1. インポート追加（L17付近）:
```typescript
import { GeneratedBadge } from '../../../ui/GeneratedBadge';
import type { GeneratedContentContainer, GeneratedSampleItem } from '../../../../types/ui-spec.types';
```

2. サンプルカードstate追加（L39付近）:
```typescript
const sampleCardsConfig = spec.config?.sampleCards as GeneratedContentContainer | undefined;
const [sampleCards, setSampleCards] = useState<GeneratedSampleItem[]>(
  sampleCardsConfig?.items || []
);
```

3. サンプルカード操作ハンドラー追加:
```typescript
const handleAdoptSample = useCallback((sample: GeneratedSampleItem) => {
  controllerRef.current.addCard(sample.text);
  setCards(controllerRef.current.getCards());
  setSampleCards(prev => prev.filter(s => s.id !== sample.id));
  emitAllPorts();
}, [emitAllPorts]);

const handleDismissSample = useCallback((sampleId: string) => {
  setSampleCards(prev => prev.filter(s => s.id !== sampleId));
}, []);
```

4. JSXにサンプルカードセクション追加（L209、cardsGridの前）:
```tsx
{sampleCards.length > 0 && (
  <div className={styles.sampleCardsSection}>
    <div className={styles.sampleCardsHeader}>
      <GeneratedBadge />
      <span>こんなアイデアはいかがですか？</span>
    </div>
    <div className={styles.sampleCardsGrid}>
      {sampleCards.map((sample) => (
        <div key={sample.id} className={styles.sampleCard}>
          <div className={styles.sampleCardText}>{sample.text}</div>
          <div className={styles.sampleCardActions}>
            <button onClick={() => handleAdoptSample(sample)}>+ 使う</button>
            <button onClick={() => handleDismissSample(sample.id)}>×</button>
          </div>
        </div>
      ))}
    </div>
  </div>
)}
```

---

### Step 9: BrainstormCards CSSスタイル追加

**ファイル**: `concern-app/src/components/widgets/v3/BrainstormCards/BrainstormCards.module.css`

```css
.sampleCardsSection {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
  border-radius: 12px;
  border: 1px dashed #F59E0B;
}

.sampleCardsHeader {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-size: 14px;
  color: #92400E;
}

.sampleCardsGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.sampleCard {
  padding: 12px;
  background: white;
  border-radius: 8px;
  border: 1px solid #FCD34D;
}

.sampleCardText {
  font-size: 14px;
  color: #374151;
  margin-bottom: 8px;
}

.sampleCardActions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}
```

---

### Step 10: 追加Widget対応（EmotionPalette, SwotAnalysis）

BrainstormCards完成後、同様のパターンで:

1. **EmotionPalette** (Type A): generationHints.labelsで8つの感情ラベルを動的生成
2. **SwotAnalysis** (Type B): generationHints.samplesで各象限に1つずつサンプル配置

---

## 修正ファイル一覧

| ファイル | 変更内容 |
|----------|----------|
| `specs/dsl-design/v4/DSL-Spec-v4.0.md` | Section 9を正式仕様として更新 |
| `server/src/types/v4/ui-spec.types.ts` | GeneratedSampleItem, GeneratedContentContainer追加 |
| `server/src/types/v4/widget-definition.types.ts` | WidgetGenerationHints追加 |
| `server/src/definitions/v4/widgets.ts` | BrainstormCardsにgenerationHints追加 |
| `server/src/prompts/v4/uispec-generation.prompt.ts` | Section 5追加 |
| `server/src/services/v4/UISpecGeneratorV4.ts` | generationHintsをプロンプトに含める |
| `concern-app/src/types/ui-spec.types.ts` | 型定義追加（バックエンドと同期） |
| `concern-app/src/components/ui/GeneratedBadge/*` | **新規作成** |
| `concern-app/src/components/widgets/v3/BrainstormCards/BrainstormCards.tsx` | サンプルカードUI追加 |
| `concern-app/src/components/widgets/v3/BrainstormCards/BrainstormCards.module.css` | スタイル追加 |

---

## テスト戦略

1. **手動テスト**: 悩み入力→BrainstormCards表示→サンプルカード確認
2. **サンプル採用/却下**: 「+ 使う」「×」ボタンの動作確認
3. **既存機能**: サンプルなしでも従来通り動作することを確認
4. **isGeneratedマーカー**: レスポンスにマーカーが含まれることを確認


## 補足

### generatedValueの生成タイミングをORS/DpGではなくUISpecにした脳内議論
コンテンツ生成はどこで行うべきか?
(stage summary, widget descriptionの生成タイミングでもあることを考慮)

責任範囲(それぞれでやりたくない理由): 
ORS: データ構造を定義．この際にここにvalueをgenerateする必要あり，など発見を主にする
UISpec: widget詳細などを含む?

UISpec生成時にやった方が良さそう:
UIを考える際に内容も考える，LLMがでっち上げ得意なことに期待．
UI仕様の方でどう生成データを流し込むかの連携必要:UISpecDSLの知識必要

w2wrの結果をより良くするならORS/DpG時が理想だが，w2wrは重要技術であるが本当のコアMVPではないので，今回は重要度の比重を下げる
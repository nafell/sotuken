# Phase 7: 実験環境統合とUX改善 - 要件定義書 & 設計書

## 1. プロジェクト概要
Phase 6で構築された実験環境の基盤（ガワ）に、`/dev-demo/full-flow` で検証済みの思考整理ロジック（中身）を統合し、実運用可能な実験プラットフォームを完成させる。また、使用者の目的に応じたページ構造の再編を行う。

## 2. ページ構造の改修（サイトマップ）

使用者の目的（実験実施、データ分析、設定）に基づいて階層を整理する。

```
/research-experiment/
├── / (Dashboard)
│   ├── クイックアクセス: 最新のセッション、統計サマリー
│   └── ナビゲーションカード: 「実験を行う」「データを見る」「設定」
│
├── /new (実験を行う - Experiment Launcher)
│   ├── /technical (技術検証モード)
│   │   └── 自動実行ランナー設定・実行画面
│   ├── /expert (専門家評価モード)
│   │   └── テストケース選択・評価者設定画面
│   └── /user (ユーザー実験モード)
│       └── 被験者ID発行・実験開始画面
│
├── /execute/:sessionId (実験実行画面 - Common Execution Environment)
│   │   ※ モードによって挙動が変化
│   └── 統合されたFullFlowUI (Capture -> Plan -> Breakdown)
│
├── /data (データ閲覧 - Data Viewer)
│   ├── /sessions (セッション一覧)
│   │   ├── フィルタ: モード別、日付別、成功/失敗
│   │   └── CSVエクスポート
│   ├── /sessions/:sessionId (セッション詳細)
│   │   ├── メトリクス詳細
│   │   └── 生成アーティファクト閲覧
│   └── /replay/:sessionId (リプレイモード)
│       └── 読み取り専用でフローを再生
│
└── /settings (設定)
    ├── モデル設定 (Gemini Pro/Flash/Lite)
    ├── Widget構成設定
    └── システムプロンプト編集（Advanced）
```

## 3. 機能要件

### 3.1 実験モード別要件

| モード | 目的 | ユーザー | 入力ソース | 進行方式 | 保存データ |
|---|---|---|---|---|---|
| **技術検証** | 性能測定 | 開発者 | 定義済みテストケース(JSON) | **完全自動** (APIのみで完結も可) | トークン数, レイテンシ, エラー率 |
| **専門家評価** | 品質評価 | 専門家 | 定義済みテストケース(JSON) | **手動操作** (評価者が操作/観察) | + 評価スコア(Forms連携) |
| **ユーザー実験** | 効果検証 | 被験者 | **自由入力** (ユーザーの悩み) | **手動操作** (被験者が利用) | + 操作ログ, アンケート |

### 3.2 統合実行環境 (`/execute/:sessionId`)

`FullFlowContainer` をベースに、以下の機能を拡張した `ExperimentExecutor` コンポーネントを作成する。

1.  **モード適応**:
    *   URLパラメータまたはセッション設定からモードを判定。
    *   **技術検証**: UIレンダリングをスキップし、バックグラウンドでAPIを連続コールする「ヘッドレスモード」も検討（今回はUIありで自動進行ボタンをつける形でも可）。
    *   **専門家評価**: テストケースの内容（`concernText`）を初期値としてセットし、Captureフェーズをスキップまたは確認のみで通過。
    *   **ユーザー実験**: 空の状態からスタート。Captureフェーズでの入力必須。

2.  **データ永続化フック**:
    *   各フェーズ/ステージ完了時（`onStageComplete`）に、APIサーバーへデータを送信。
    *   `POST /api/experiment/sessions/:id/widget-states`
    *   `PATCH /api/experiment/sessions/:id` (進捗更新)

3.  **中断・再開**:
    *   ブラウザリロード対策として、`sessionId` をキーにサーバーから最新状態をフェッチして復元する機能（Phase 7 Step 2では優先度低、Step 3で検討）。

## 4. 実装計画 (Phase 7 Roadmap)

### Step 1: ページ構造/機能階層の見直し
*   ルーティング定義の変更 (`App.tsx`)
*   ダッシュボードUIの刷新 (`ExperimentDashboard.tsx`)
*   ランチャーページの実装 (`/new/*`)

### Step 2: 未実装機能の実装・統合 (Core)
*   **`ExperimentExecutor` コンポーネントの実装**:
    *   `useFullFlowState` を拡張し、実験セッションIDと紐づける `useExperimentFlow` フックを作成。
    *   API連携部分の実装。
*   **モード別挙動の実装**:
    *   テストケース読み込みロジック。
    *   自動/手動の切り替え。

### Step 3: UX改善 & プロダクト品質向上
*   **UIブラッシュアップ**:
    *   実験用ヘッダー（現在のモード、トークン数、経過時間を常時表示）。
    *   ローディング表示の改善。
*   **DSL/プロンプト改善**:
    *   生成精度の向上（Phase 6の課題フィードバック）。

## 5. 決定事項 (User Feedback)

1.  **技術検証の自動化**:
    *   **決定**: UIベースで実装する。開始前に実験内容（ケース、Widget数、モデル等）を選択・確認できる画面を用意し、実行ボタンで自動進行させる。

2.  **ユーザー実験の評価**:
    *   **決定**: 主観評価（アンケート）で十分とする。ボトルネック診断の正解一致率などは求めない。

3.  **既存コード (`/dev-demo`) の扱い**:
    *   **決定**: **共通化しない**。
    *   `/dev-demo` はPoCとして現状のまま保存し、手を加えない。
    *   実験環境 (`/research-experiment`) は独立した実装として、必要なロジックはデモから**コピー＆ペースト（移植）**して実装する。機能比較のため、互いに干渉させない。

# Phase 7 Step 2: Core Feature Implementation Specification

## 1. Overview
This document specifies the core features implemented for the Research Experiment Environment (Phase 7 Step 2). The focus is on enabling the "Capture -> Plan -> Breakdown" flow with detailed metrics recording, specifically for LLM prompts and UI rendering times.

## 2. Database Schema Changes

### 2.1. New Table: `experiment_generations`
A new table has been added to store the history of LLM generations within a session. This allows for a 1-to-N relationship between a session and its multiple generation steps (e.g., Plan Diverge, Plan Organize).

| Column Name | Type | Description |
| :--- | :--- | :--- |
| `id` | UUID (PK) | Unique identifier for the generation record |
| `session_id` | UUID (FK) | Reference to `experiment_sessions` |
| `stage` | Text | The stage of the flow (e.g., 'diverge', 'organize') |
| `model_id` | Text | The LLM model used (e.g., 'gemini-2.5-flash') |
| `prompt` | Text | **[NEW]** The full prompt sent to the LLM |
| `generated_oodm` | JSONB | The raw OODM JSON generated by the LLM |
| `generated_dsl` | JSONB | The final UI Spec DSL |
| `prompt_tokens` | Integer | Token count for the prompt |
| `response_tokens` | Integer | Token count for the response |
| `generate_duration` | Integer | Time taken for LLM generation (ms) |
| `render_duration` | Integer | **[NEW]** Time taken for React to render the UI (ms) |
| `created_at` | Timestamp | Creation timestamp |

## 3. Backend API Changes

### 3.1. `POST /api/ui/generate-v3` (Updated)
*   **Behavior**:
    1.  Generates UI Spec using `UISpecGeneratorV3`.
    2.  **Saves the result to `experiment_generations` table**, including the `prompt`.
    3.  **Returns `generationId`** to the client.
    4.  **Does NOT return `prompt`** to the client (security/privacy).

### 3.2. `PATCH /api/experiment/generations/:generationId` (New)
*   **Purpose**: Allows the client to update metrics for a specific generation record.
*   **Payload**: `{ renderDuration: number }`
*   **Use Case**: The frontend measures the time from receiving the response to finishing the render, then calls this endpoint to save it.

## 4. Frontend Architecture

### 4.1. Component Structure
The experiment flow is managed by a new set of dedicated components, independent of the `/dev-demo` implementation to ensure stability for research.

*   **`ExperimentExecutor`**: The main container that manages the state machine (Capture -> Plan -> Breakdown) using `useExperimentFlow`.
*   **`ExperimentCapture`**: Handles the initial concern input.
    *   *Technical/Expert Mode*: Auto-proceeds if initial text is provided.
*   **`ExperimentPlan`**: Manages the 4-stage planning process (Diverge -> Organize -> Converge -> Summary).
    *   *Metrics*: Measures `renderDuration` using `performance.now()` and calls `updateGeneration`.
    *   *Technical Mode*: Auto-proceeds through stages.
*   **`ExperimentBreakdown`**: Handles the final task breakdown.

### 4.2. State Management (`useExperimentFlow`)
A custom hook that encapsulates the logic for:
*   Phase transitions.
*   Data persistence (calling `ExperimentApiService`).
*   Error handling.
*   Auto-progression logic for Technical/Expert modes.

### 4.3. Service Layer (`ExperimentApiService`)
Refactored to a class-based service to support better organization and new methods:
*   `updateGeneration(generationId, updates)`: Calls the new PATCH endpoint.
*   `createSession`, `updateSession`: Existing methods for session management.

## 5. Data Flow for Metrics

1.  **LLM Generation**:
    *   Client calls `generateUIV3`.
    *   Server generates prompt, calls LLM.
    *   Server saves `prompt`, `generateDuration`, `tokens` to DB (`experiment_generations`).
    *   Server returns `generationId` and `uiSpec`.

2.  **UI Rendering**:
    *   Client receives `uiSpec`.
    *   `ExperimentPlan` starts timer (`performance.now()`).
    *   `UIRendererV3` renders the widgets.
    *   `ExperimentPlan` stops timer (in `useEffect`).
    *   Client calls `updateGeneration(generationId, { renderDuration })`.
    *   Server updates the record in DB.

## 6. Mode-Specific Behaviors

| Feature | User Mode | Expert Mode | Technical Mode |
| :--- | :--- | :--- | :--- |
| **Initial Input** | Manual Entry | Pre-filled from Test Case | Pre-filled from Test Case |
| **Capture Phase** | Manual Submit | Auto-proceed | Auto-proceed |
| **Plan Phase** | Manual Step-by-step | Manual Step-by-step | **Auto-proceed** (simulated user) |
| **Breakdown** | Manual Review | Manual Review | Auto-complete |


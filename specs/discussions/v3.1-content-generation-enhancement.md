# Discussion: Content Generation Enhancements (DSL v3.1)

**Date**: 2025-12-01
**Topic**: Improving the relevance and quality of LLM-generated content within UI widgets.

## 1. 背景と課題 (Background & Problem)

現在のシステム（DSL v3.0）では、LLMによるUI構造の生成（どのWidgetを使うか、どう配置するか）は概ね成功しています。しかし、**Widget内部に表示されるコンテンツの生成**に関しては、まだ改善の余地があります。

現状の課題として、以下のような点が挙げられます：

1.  **コンテンツが静的・一般的すぎる**:
    *   例えば `Emotion Palette` は常に固定の8個の感情が表示されており、ユーザーの特定の悩み（例：「仕事を辞めたい」）に対する微妙なニュアンス（「解放感」「不安」「罪悪感」など）を捉えきれていません。
    *   `SWOT Analysis` の各象限の説明も一般的で、ユーザーが具体的に何を書き込めばいいのか迷うことがあります。

2.  **「叩き台」がない**:
    *   多くのWidgetが空の状態で提示されるため、ユーザーはゼロから考え始める必要があり、認知負荷が高い状態です（Cold Start Problem）。
    *   「例えばこういうこと」というサンプルが提示されていれば、それを修正したり削除したりする形で思考をスタートできます。

3.  **目的が曖昧**:
    *   そのWidgetで「何を」分析すべきかの主語が曖昧な場合があります。
    *   例：`Priority Slider Grid` で優先度をつける際、「緊急度」なのか「重要度」なのか、あるいは「やりたい度」なのかが文脈によって異なるべきですが、現在は固定的なラベルしかありません。

4.  **文脈の分断**:
    *   ステージが進むにつれて、前のステージで何を入力したか、どういう思考の流れだったかが薄れがちです。
    *   常に「これまでのあらすじ」が提示されていることで、一貫した思考が可能になります。

## 2. 改善の方向性 (Direction)

**「ユーザーにとって Relevant (自分ごと) なUIを提供する」** をコアコンセプトとします。

単にUIの形を変えるだけでなく、**中身（コンテンツ）を文脈に合わせて動的に生成・カスタマイズ**することで、ユーザーが「自分のために用意されたノート」だと感じられる体験を目指します。

## 3. 具体的な改善案 (Proposed Solutions)

### 3.1 コンテンツのカスタマイズ (Context-Aware Customization)

Widgetの構成要素を、ユーザーの悩み（Concern Text）に合わせて動的に生成します。

*   **Emotion Palette (感情パレット)**
    *   **現状**: 固定の8色・8感情。
    *   **改善**: 悩みの内容から、その状況で抱きがちな感情を8個生成する。色もその感情に合わせたものを指定する。
    *   **例**: 「プレゼン前で緊張している」→「焦燥感(赤)」「期待(黄)」「恐怖(紫)」など。

*   **SWOT Analysis (SWOT分析)**
    *   **現状**: 「Strengths」「Weaknesses」などの固定ラベルのみ。
    *   **改善**: 各象限の説明文（PlaceholderやDescription）を文脈に合わせる。
    *   **例**: テーマが「転職」なら、Threatsの説明を「転職した場合に起こりうる最悪の事態は？」とする。

*   **Tradeoff Balance (トレードオフ天秤)**
    *   **現状**: A/Bの選択肢が抽象的。
    *   **改善**: 具体的な選択肢A/BをLLMが提案し、初期値としてセットする。ユーザーはそれを編集可能にする。
    *   **例**: 「転職する」vs「現職に留まる」。

### 3.2 サンプルアイテムの提示 (Sample Items / Pre-generation)

「空箱」を渡すのではなく、いくつかのアフォード（手掛かり）が入った状態で渡します。

*   **Brainstorm Cards**: 呼び水となるアイデアを2つ程度生成して配置しておく。
*   **SWOT Analysis**: 各象限に1つずつ、典型的な要素を入れておく。
*   **Priority Slider Grid**: 評価すべき項目を3つ程度リストアップしておく。
*   **Matrix Placement**: 配置すべきアイテムを3つ程度用意する。
    *   *課題*: 現状のUIでは新規アイテムが中央に重なって生成されるため、初期配置の座標も指定するか、UI側で重ならないように配置するロジックが必要。
*   **Dependency Mapping**: 関連しそうなノード（要素）を洗い出しておく。エッジ（関係線）はユーザーがつなぐことで思考を促す。

### 3.3 Widgetの目的・主語の明確化 (Clarifying Purpose)

各Widgetに「このWidgetで何を考えるべきか」というコンテキスト依存の説明文（Instruction）を付与します。

*   **実装イメージ**: 全Widget共通のプロパティとして `description` (または `instruction`) を持ち、LLMが生成する。
*   **例**: `Priority Slider Grid` において、「転職先の条件として、何を最優先するか順位をつけてみましょう」と表示する。

### 3.4 ステージサマリー (Stage Summary)

各ステージの冒頭（または常時表示エリア）に、これまでの思考の要約を表示します。

*   **Capture → Plan**: 「あなたは〇〇について悩んでおり、特に△△が気になっていますね」
*   **Plan → Breakdown**: 「方針として□□を選択しました。では具体的に分解しましょう」
*   **目的**: ユーザーが「今何のためにこれをやっているのか」を見失わないようにする（アンカー効果）。

## 4. システム仕様への影響 (System Impact)

### 4.1 DSL (UISpec) の拡張

#### 4.1.1 generatedValue, generatedContent
Widget内でLLMに生成して欲しいコンテンツ（ラベルなど）をDSL上で抽象化する形にします。
generatedValueは単一値で仕様が明確に決まった概念です。定義:
- field_name: フィールド名
- type: 型
- instruction: LLMへの指示
generatedContentは複雑な構造を持つ可能性があるため、より柔軟な表現を提供するため、抽象概念に留めておきます。

表示用ラベルなど単純な値(3.1, 3.3)はgeneratedValueを活用します。
複雑な例(3.2)はgeneratedContentの実例であるsampleItemSpecを活用します。

#### 4.1.2 editableList
「アイテム編集可能リスト」をDSL上で抽象化し、そこにサンプル生成の仕様と実態を持たせる形にします。
DSLに`editableList`という概念を導入します。
- プロンプト側DSLのeditableListはsampleItemSpecを持ちます。sampleItemSpecは個数とアイテム仕様を持ち、アイテム使用は一つないし複数のgeneratedValueを含むことができます。
- UI側DSLのeditableListはsampleItems実態を持ちます。 

#### 4.1.3 UI Atoms (UIComponent)

DSL Core Specification v3.0 で定義されている `UIComponent` を活用します。
`EditableList` を新しい `UIComponent` タイプとして定義し、Widgetのポートと紐付けます。

**New UIComponent Type: `editable-list`**
- **Role**: ユーザーがアイテムのリストを編集・追加するためのUI。
- **Props**:
  - `samples`: 生成されたサンプルアイテムの配列。
  - `itemSchema`: アイテムの構造定義（バリデーションや入力フォーム生成用）。

#### Widget Definition (`widgets.ts`)

Widget定義では、各ポートが「どのUI Componentを使用してレンダリングされるか」を指定します。
これは `widget-to-widget reactivity` を担う `ports` とは別に、**UI表現** を定義するメタデータとして扱います。

```typescript
interface WidgetDefinition {
  // ...
  
  ports: {
    inputs: {
      id: string;
      dataType: string;
      
      // UI Component Binding
      uiComponent?: {
        type: "editable-list"; // UIComponent.type
        
        // 生成指示（Generatorが参照）
        generationSpec?: {
          instruction: string;
          count: number;
          itemStructure: {
            [field: string]: {
              type: "generatedValue";
              dataType: string;
              instruction: string;
            };
          };
        };
      };
    }[];
  };
}
```

#### UI Spec (`ui-spec.types.ts`)

生成されるUISpecでは、**`config` フィールド** に生成されたコンテンツ（サンプルなど）を格納します。
`inputs` はあくまで「現在の値（ユーザー入力やリアクティブな値）」を保持する場所とし、静的な生成コンテンツとは分離します。

```typescript
interface WidgetSpec {
  // ...
  
  // 生成された静的コンテンツ（AtomのPropsとして渡される）
  config: {
    [portId: string]: {
      samples?: any[]; // 生成されたサンプル
    };
    // その他、promptやdescriptionなどもここに
    prompt?: string;
    description?: string;
  };

  // 動的な値（ユーザー入力など）
  inputs: {
    [portId: string]: {
      value: any[]; 
    };
  };
}
```

### 4.2 Generator (Prompt) の改修

*   **Widget定義の提示**: `uiComponent.generationSpec` の情報を含めます。
*   **生成指示**: 
    1.  `generationSpec` に従ってサンプルデータを生成してください。
    2.  生成結果は `config.{portId}.samples` に格納してください。
    3.  `inputs` は空（またはデフォルト値）のままで構いません。

**生成されるJSONのイメージ**:

```json
{
  "id": "brainstorm_1",
  "component": "brainstorm_cards",
  "config": {
    "description": "あなたの強みを書き出してみましょう",
    "cards": {
      "samples": [
        { "text": "粘り強さ", "color": "#4A90E2" },
        { "text": "分析力", "color": "#50E3C2" }
      ]
    }
  },
  "inputs": {
    "cards": {
      "value": [] 
    }
  }
}
```

### 4.3 Frontend (Renderer) の改修

*   **Widget実装の修正**: 
    *   `EmotionPalette` や `BrainstormCards` が `spec.config` を読み込むように修正します。
    *   `spec.config.description` があれば、それを優先して表示します。
    *   `spec.config.{portId}.samples` があれば、それを初期値としてセットするか、候補として表示します。


## 5. 議論点 (Open Questions)

*   **過学習・誘導のリスク**: AIが具体例を出しすぎると、ユーザーの思考がそれに引きずられてしまう（アンカリング）可能性があります。「あくまで例です」という見せ方や、簡単に削除できるUIが重要になります。
*   **既存Widgetとの整合性**: `Card Sorting` や `Question Card Chain` は既に独自にコンテンツ生成を行っています。これらを新仕様（`samples` フィールド）に統合するか、共存させるかを検討する必要があります。統一した方がメンテナンス性は高まります。

---

この方針に基づき、v3.1として仕様策定と実装を進めます。

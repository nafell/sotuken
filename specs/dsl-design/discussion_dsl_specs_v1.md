# DSL仕様策定ディスカッション記録 v1.0
**「頭の棚卸しノート」動的UI生成システム - 仕様策定プロセス全記録**

---

## 📋 ディスカッション概要

**日時:** 2025年10月12日  
**参加者:** 学生（情報工学部）、指導教官役AI  
**目的:** LLM動的UI生成の具体的仕様策定  
**成果物:** 5つの確定仕様書 + 実装ロードマップ

---

## 🎯 ディスカッションの出発点

### 学生からの初期質問

> 私は、LLMを活用した動的UI生成に関する卒業研究を進めている情報工学部の学生です。あなたには、この研究の指導教官の役割を担っていただき、私とのディスカッションを通じて、研究の核心部分である「動的UIの仕様策定」をサポートしてほしいです。

### 提示された背景資料

1. **先行研究論文**: Jelly (CHI 2025) - Generative and Malleable User Interfaces
   - タスク駆動型データモデル（Object-Relational Schema + Dependency Graph）
   - UI仕様（DSL）の2層構造
   - 汎用的なタスク対応

2. **プロジェクト概要**: MVP要件定義書
   - アプリ名：頭の棚卸しノート
   - コンセプト：思考整理・認知負荷軽減
   - コア機能：実態把握→方針立案→細分化の3段階フロー
   - 動的UIの期待：プロセスに合わせた最適な入力・表示形式

### 初期の課題認識

- Jellyは汎用的だが、このアプリには不要な機能も多い
- どの部分を採用し、どう特化させるか不明確
- 動的UIの具体的な仕様が未定

---

## 🔄 ディスカッションの流れ（Phase 1: 基本仕様の確定）

### Step 1: 最初の問いかけ（教官役）

**質問:**
> 最優先KPI「着手率」を最大化するために、動的UIが反応すべき一次トリガーを次の3つから上位2つに絞るとしたらどれですか？
> - 思考段階の遷移（実態把握→方針→細分化）
> - コンテキストfactorsの変化（time_of_day / location_category / available_time）
> - 停滞・未着手時間の閾値超え

**学生の回答:**
> このアプリの機能は思考整理とタスク実行の2つが大きな機能です。
> 
> 1. **思考段階の遷移**は必須トリガー
>    - 入力ウィジェットが状況に応じて変化
>    - 画面構成全体が変わる
> 
> 2. **タスク実行のトリガー**はホーム画面表示時
>    - 最も推奨するタスク1項目をウィジェット化
>    - 色・要素サイズ・文字サイズなどを動的変更

**重要な判断:** タスクが2種類あることを明確化

---

### Step 2: ステージ別UI最小要件の確定

**質問:**
> ステージごとのUI最小要件を1つに絞るなら何ですか？
> - 実態把握: 例）paragraph入力＋クイックタグ
> - 方針立案: 例）radio/selectでアプローチ選択
> - 細分化: 例）action_templateから「次の1歩」を生成

**学生の回答:**

1. **実態把握（capture）**: `radio/select`
   - paragraph入力は毎回固定
   - 次画面から動的UIのradio/selectで問診票を生成

2. **方針立案（plan）**: 工夫のしがいがある、凝ったUXを実現したい
   - 反実仮想トグル
   - トレードオフ・スライダー
   - プレビュー付き戦略ピッカー
   - **→ 全て採用を決定（固定UIとの最大差別化ポイント）**

3. **細分化（breakdown）**: 並べ替え可能リスト

**重要な判断:** planステージを差別化の核心と位置づけ

---

### Step 3: スコアリング・ゲーティングの確定

**確定した仕様:**

```
スコア式 = 0.4×importance + 0.3×urgency + 0.2×staleness + 0.1×contextFit

ゲーティング:
  if available_time >= estimate → 本体タスク
  elif available_time >= 10分 AND micro_step独立可 → マイクロステップ
  else → 準備ステップ

サリエンシー:
  0=base, 1=emphasis, 2=primary, 3=urgent
  運用: 1/2が主力、3は稀（締切<24h かつ 重要度≥高）
```

**重み配分の理由:**
- importance 40%: 長期的価値を最重視
- urgency 30%: 締切圧にも反応するが重要度より軽く
- staleness 20%: 放置タスクの再浮上
- contextFit 10%: センサー推定誤差を考慮して控えめ

**正規化方法:**
- importance: 3段階（0.33/0.67/1.0）
- urgency: 1 - logistic(due_in_hours; mid=48, k=0.1)
- staleness: logistic(days_since_last_touch; mid=3, k=1.5)
- contextFit: time+0.2, location+0.3, time_available+0.5（上限1.0）

---

## 🔄 ディスカッションの流れ（Phase 2: 2層構造の発見）

### Step 4: 重要な気づき（学生）

> 先行研究ではUIのDSLを生成する前にデータモデルを生成しています。このアプリはユースケースが固定で現在の要件はJellyほどUIを変化させませんが、思考整理フローを固定するのではなくLLMがフローを毎回構築する手法もできるようにしたいです。そのため、Object-Relational Schema + Dependency Graphを一旦挟む設計にしたいです。

**これまで決めたUIのDSL仕様も再考の余地があります。**

**教官の反応:**
> 重要な視点をありがとうございます。Jellyの設計思想を正しく理解すると、確かに**2層構造**（データモデル→UI仕様）が必要です。

**問題点の指摘:**
- 先ほど決めたDSL v0.5は「UI仕様」だけを記述
- Jellyでは以下の2段階:
  1. Object-Relational Schema（タスクのデータ構造）を生成
  2. その上でUI Specification（レンダリング方法）を生成

**この2段階が思考整理フローをLLMが毎回構築する柔軟性を生み出している**

---

### Step 5: ステージ別の動的化レベルの確定

**質問:**
> 以下のうち、どのステージでデータモデルを動的生成しますか？

**学生の回答:**

| ステージ | 動的化レベル | 理由 |
|---------|------------|------|
| **capture** | 限定的動的 | LLMに動的変化させるのは内容の変更や既存パーツの組み合わせをする程度 |
| **plan** | 🌟フル動的 | 一番LLMが動的画面設計をクリエイティブに行なってほしい |
| **breakdown** | ほぼ固定（captureより固定寄り） | planが適切に行われていれば、定型的なタスクになっているはず |
| **home** | 構造は常に同じ | タスクカードのsaliency程度。将来的にミニ実行画面機能を搭載予定 |

**重要な判断:** planステージに動的化を集中

---

### Step 6: DSL命名と仕様書の範囲

**学生の決定:**
- 命名: `DataSchemaDSL v1.0` + `UISpecDSL v1.0`
- 仕様書の範囲: 一般的な言語仕様は書くが、Jellyほど詳細にはしない
  - 理由: Jellyは汎用、このアプリは思考整理特化
  - 実際に使う型だけを定義

**Jellyとの差異:**
- DICT型: ほぼ使用しない
- PNTR型: ACTION依存のみ（限定的使用）
- 依存関係: Update系のみ（Validateは将来拡張）

---

### Step 7: ホーム推奨タスクの分離判断（重要な転換点）

**質問:**
> ホーム推奨タスクの選出（スコアリング・ゲーティング）は、この2層構造のどこに位置しますか？

**学生の判断:**
> ここは思考整理と完全に区分けして、一旦、データモデル化を経ないでUI生成する実装にすべきですか？ただし、将来的にミニ実行画面を組み込めるよう変更容易性に考慮した実装としたい。
> 
> **と言うか、タスクが全く違うのでDSL仕様も分けちゃったほうがいいかも?**

**教官の合意:**
> **結論: DSL仕様を2系統に完全分離**
> 
> **理由:**
> 1. タスクが完全に異なる
>    - 思考整理: ユーザーが「考える」フロー
>    - タスク実行: システムが「推す」UI
> 
> 2. データモデルの有無
>    - 思考整理: DataSchemaDSL必要（LLMが構造を決める）
>    - タスク実行: Schema不要（構造固定、saliency制御のみ）
> 
> 3. 将来拡張の方向性
>    - 思考整理: より柔軟なEntity生成
>    - タスク実行: ミニ実行画面の埋め込み（構造は変えない）

**重要な判断:** 2系統DSLへの分離決定

---

## 📐 最終確定仕様の全体像

### 系統1: 思考整理DSL（DataSchema + UISpec）

**適用範囲:** capture, plan, breakdown

**パイプライン:**
```
ユーザー入力
  ↓
DataSchemaDSL生成（Entity構造決定）
  ↓
UISpecDSL生成（レンダリング方法決定）
  ↓
Rule-based Rendering
  ↓
React UI表示
```

**ステージ別動的化:**
- capture: 簡易動的（固定Schema + 質問内容調整）
- plan: フル動的（Entity構造から自由設計）
- breakdown: ほぼ固定（固定Template使用）

**主要Entity:**
- CONCERN（ルート）
- QUESTION（captureで使用）
- STRATEGY（planで使用）
- ACTION（breakdownで使用）

**属性型（思考整理特化の簡易版）:**
- SVAL: string, number のみ
- ARRY: 配列（expanded or summary）
- PNTR: ACTION間の依存のみ
- DICT: tradeoffsのみ使用

---

### 系統2: タスク推奨DSL（Schema不要）

**適用範囲:** home推奨

**パイプライン:**
```
factors収集 + tasks[]
  ↓
スコアリング・ランキング
  ↓
ゲーティング（variant決定）
  ↓
サリエンシー決定
  ↓
TaskRecommendationDSL生成
  ↓
TaskCard Renderer
  ↓
React UI表示
```

**なぜDataSchema不要か:**
- タスクカード構造は常に固定
- 変化するのは「選出」と「強調」だけ
- DataSchemaを挟むと複雑化するだけ

**確定仕様:**
- スコア式: `0.4×importance + 0.3×urgency + 0.2×staleness + 0.1×contextFit`
- ゲーティング: task_card / micro_step_card / prepare_step_card
- サリエンシー: 0 (base) / 1 (emphasis) / 2 (primary) / 3 (urgent)

---

## 🎯 重要な設計判断とその理由

### 判断1: 2系統DSLへの分離

**理由:**
- タスク性質が根本的に異なる（考える vs 推す）
- データモデルの必要性が異なる（動的 vs 固定）
- 将来拡張の方向性が異なる

**利点:**
- 各系統を独立して最適化可能
- 複雑度の適切な管理
- 変更容易性の確保

---

### 判断2: planステージを差別化の核心に

**理由:**
- ユーザーが最も「考える」場面
- 固定UIとの差が最も明確になる
- 3種類のカスタムウィジェット（反実仮想トグル、トレードオフスライダー、プレビュー付き戦略ピッカー）を全採用

**期待効果:**
- 意思決定の質向上
- 納得感の向上
- 下流の着手率向上

---

### 判断3: Jellyの簡略化（思考整理特化）

**Jellyとの差異:**

| 要素 | Jelly（汎用） | このアプリ（思考整理特化） |
|------|-------------|----------------------|
| 対象タスク | あらゆる情報タスク | 思考整理・タスク分解のみ |
| DICT型 | 頻繁に使用 | ほぼ不使用 |
| PNTR型 | 頻繁に使用 | ACTION依存のみ |
| 依存関係 | Update + Validate | Updateのみ |

**理由:**
- 過度に汎用的な機能は複雑度を増すだけ
- 実際に使う型に限定して簡潔に
- 将来拡張の余地は残す

---

### 判断4: スコア重みの配分

**確定値:**
- importance: 40%
- urgency: 30%
- staleness: 20%
- contextFit: 10%

**理由:**
- 価値（importance）を主信号に
- 期限圧（urgency）も反応するが重要度より軽く
- 停滞解消（staleness）を補助
- 状況適合（contextFit）は推定誤差を考慮して控えめ

**A/Bテストで検証予定**

---

### 判断5: サリエンシー運用ルール

**確定値:**
- Level 0: base（ほぼ使用しない）
- Level 1: emphasis（準備ステップ）10%
- Level 2: primary（標準推奨）85%
- Level 3: urgent（緊急）5%

**理由:**
- Level 3を多用すると慣れて効果が薄れる
- 「重要かつ締切直前」の2条件を満たす場合のみ最大強調
- 通常は安定したLevel 2で視覚的疲労を避ける

---

## 📊 ディスカッションの成果物

### 作成された仕様書（5つ）

1. **DataSchemaDSL v1.0 言語仕様書**
   - タスク駆動型データモデル定義
   - Entity定義（CONCERN/QUESTION/STRATEGY/ACTION）
   - 依存関係グラフ
   - ステージ別生成パターン

2. **UISpecDSL v1.0 言語仕様書**
   - DataSchema→UIマッピング
   - レンダリングタイプ定義
   - レイアウト仕様
   - 再生成ポリシー

3. **TaskRecommendationDSL v1.0 仕様書**
   - Schema不要の簡易版
   - スコアリング・ゲーティング仕様
   - サリエンシー運用ルール
   - 将来拡張（ミニ実行画面）

4. **アーキテクチャ設計書 v2.0（更新版）**
   - 2系統DSLアーキテクチャ
   - サービス層実装指針
   - API構造
   - Rule-based Rendering方針

5. **Phase 1改訂ロードマップ v2.0**
   - Phase 1A: 思考整理DSL基盤（Week 7-8）
   - Phase 1B: タスク推奨DSL基盤（Week 9）
   - Phase 1C: Rule-based Rendering統合（Week 10）
   - 詳細タスク分解（26タスク、70-90時間）

### ボーナス

6. **DSL体系概要書 v1.0**
   - 5つの仕様書を横断する鳥瞰図
   - 役割別推奨読書順序
   - Jelly論文との対応関係

---

## 💡 ディスカッションから得られた学び

### 学びその1: ソクラティック・メソッドの効果

教官役が一方的に答えを提示せず、問いを投げかけることで：
- 学生自身が考え、結論を導き出せた
- 判断の理由が明確になった
- 仕様への納得感が高まった

**例:**
- 「どのステージで動的生成しますか？」→ 学生が動的化レベルを判断
- 「なぜこの重み配分か？」→ 各要素の意味を深く理解

---

### 学びその2: 適切な粒度での判断

大きな判断を小さく分解することで：
- 各決定を独立して検討できた
- 複雑度を管理できた
- 後戻りのリスクを低減

**例:**
1. トリガーを決める
2. ステージ別UIを決める
3. スコアリングを決める
4. データモデル化の必要性を判断
5. DSL分離を決める

---

### 学びその3: 先行研究の適切な活用

Jellyの設計思想を理解した上で：
- 採用すべき部分を明確化
- 簡略化すべき部分を判断
- このアプリ特有の拡張を設計

**Jellyから学んだ核心:**
- タスク駆動型データモデルの有用性
- 2層構造（DataSchema + UISpec）の重要性
- Rule-based Renderingの安定性

**このアプリ特有の判断:**
- 思考整理特化の簡略化
- 2系統DSLへの分離
- planステージへの集中

---

### 学びその4: 将来拡張性の確保

仕様策定時に将来の拡張を考慮：
- ミニ実行画面の構造を定義（実装は後）
- Validate依存関係の余地を残す
- 機械学習ベースのスコア最適化の余地

**バランス:**
- MVP時点では実装しない
- 構造上は拡張可能にしておく
- 変更容易性を確保

---

## 🎓 教官役の指導スタイル（振り返り）

### 効果的だった問いかけ

1. **最優先KPI視点での問い**
   - 「着手率最大化のために、どのトリガーを選びますか？」
   - → 目的から逆算する思考を促進

2. **最小要件への絞り込み**
   - 「各ステージのUI最小要件を1つに絞るなら？」
   - → 本質の抽出を促進

3. **理由の掘り下げ**
   - 「なぜこの重み配分か？」
   - → 判断根拠の明確化

4. **矛盾の指摘**
   - 「タスクが全く違うのでは？」（学生の気づきを支持）
   - → 設計の一貫性確保

---

### 判断を学生に委ねたポイント

教官役は以下を提案したが、最終判断は学生に委ねた：
- ステージ別の動的化レベル
- 方針立案UIの採用要素（学生が「全採用」を決断）
- DSL分離の判断（学生が「分けちゃったほうがいい」と気づく）

**効果:**
- 学生の主体性を尊重
- 判断への責任感・納得感の向上
- より深い理解

---

## 🚀 次のステップ（実装フェーズ）

### Phase 1A: 思考整理DSL基盤（Week 7-8）

**実装内容:**
- DataSchemaDSL型定義・バリデーター
- UISpecDSL型定義・バリデーター
- LLMService: Schema生成
- LLMService: UISpec生成
- API実装（`/v1/thought/*`）

**目標:** capture/plan/breakdownで動的UI生成が動作

---

### Phase 1B: タスク推奨DSL基盤（Week 9）

**実装内容:**
- TaskRecommendationDSL型定義
- ScoreRankingService実装
- スコアリング・ゲーティング・サリエンシー
- API実装（`/v1/task/rank`）

**目標:** home画面で最適タスク推奨が動作

---

### Phase 1C: Rule-based Rendering統合（Week 10）

**実装内容:**
- ComponentMapper実装
- 9種類のReactウィジェット実装
- サリエンシートークン→CSSマッピング
- E2E統合テスト

**目標:** 2系統DSLの完全統合動作

---

## 📚 参考文献

### 主要論文
- Cao, Y., Jiang, P., & Xia, H. (2025). Generative and Malleable User Interfaces with Generative and Evolving Task-Driven Data Model. CHI Conference on Human Factors in Computing Systems (CHI '25), April 26-May 1, 2025, Yokohama, Japan. https://arxiv.org/html/2503.04084v1

### 関連概念
- Task-Driven Data Model
- Object-Relational Schema
- Dependency Graph
- UI Specification (DSL)
- Rule-based Rendering
- Generative and Malleable User Interfaces (GMUI)

---

## 🎯 ディスカッションの成功要因

### 1. 明確な役割分担
- 学生: 判断・決定
- 教官: 問いかけ・判断材料の提示

### 2. 適切な問いの設計
- オープンな問い（考えを促す）
- クローズドな問い（確認・合意形成）
- 掘り下げの問い（理由の明確化）

### 3. 段階的な仕様策定
- 大きな決定→小さな決定
- 基本仕様→詳細仕様
- 1系統→2系統への進化

### 4. 先行研究の活用
- Jellyの設計思想を理解
- 必要な部分を抽出
- このアプリ特有の拡張

### 5. 実装可能性の確保
- 詳細な実装指針
- 明確な受け入れ基準
- 段階的な実装計画

---

## 📝 まとめ

### ディスカッションで確定したこと

1. **2系統DSL設計**
   - 系統1: 思考整理（DataSchema + UISpec）
   - 系統2: タスク推奨（Schema不要）

2. **ステージ別動的化レベル**
   - capture: 限定的動的
   - plan: フル動的（差別化の核心）
   - breakdown: ほぼ固定
   - home: 固定構造

3. **スコアリング仕様**
   - 確定式・正規化方法・ゲーティング・サリエンシー

4. **実装ロードマップ**
   - Phase 1A/1B/1Cの3段階
   - 26タスク、70-90時間

### 次の実装フェーズで検証すること

- [ ] planステージの動的UI生成品質
- [ ] スコア重みの妥当性（A/Bテスト）
- [ ] サリエンシー運用の効果
- [ ] 着手率の改善度

### 将来の研究発展の方向性

- ミニ実行画面の実装
- 機械学習ベースのスコア最適化
- より複雑な依存関係のモデリング
- 外部データ統合（Calendar等）

---

**このディスカッション記録は、同様の研究を進める学生や、動的UI生成システムを設計する開発者にとって、仕様策定プロセスの参考資料となることを目的としています。**

---

**文書バージョン:** 1.0  
**作成日:** 2025年10月12日  
**ステータス:** 確定（ディスカッション完了）  
**次のステップ:** Phase 1A実装開始


## 動的UI仕様書 v0.5
**「頭の棚卸しノート」動的UI生成システム**

---

## 1. この仕様書の目的

### 何を作るのか
「頭の棚卸しノート」アプリで、ユーザーの思考段階や状況に応じて画面構成を動的に変化させるシステムです。

### なぜ作るのか
従来の固定UIアプリでは、「今やるべきこと」が埋もれてしまい、着手率が低下します。この動的UIシステムは、ユーザーが**今この瞬間に最も必要としている情報と行動**を的確に提示することで、タスクへの着手率を最大化します。

### 測定する成果
- **第一指標**: ホーム画面で推奨タスクを表示してから、ユーザーが「行動報告」ボタンを押すまでのコンバージョン率（＝着手率）
- **比較対象**: 固定UI版とのA/B比較

---

## 2. 基本設計思想

### 仕様ベースの動的UI生成
この設計は、CHI 2025で発表されたJellyシステムの思想を採用しています。[arXiv, 2025](https://arxiv.org/html/2503.04084v1)

**3つの柱:**
1. **トリガー**: 「いつUIを変えるか」を明確に定義
2. **仕様**: 「どう変えるか」をルールとして記述
3. **レンダリング**: 仕様に基づいて決定的にUIを生成

**なぜこの方式か:**
- LLMに自由にUIを生成させると、毎回異なるUIになり測定が困難
- 仕様で制御することで、再現性・安定性・測定可能性を確保
- LLMは「質問文の生成」「戦略案の作成」など内容生成に集中

---

## 3. UIが変化するトリガー（2種類）

### トリガー1: 思考整理ステージの遷移
ユーザーが以下の3段階を進むとき、画面構成が変わります。

| ステージ | 何をする段階か | 主な画面要素 |
|---------|-------------|------------|
| **実態把握** (capture) | モヤモヤした関心事を書き出し、問診で掘り下げる | 自由入力欄 + 動的な選択式質問 |
| **方針立案** (plan) | どうアプローチするか戦略を選ぶ | 3種類の戦略選択支援UI |
| **細分化** (breakdown) | 具体的な次の一歩に落とし込む | 並べ替え可能なチェックリスト |

**なぜこのタイミングで変えるのか:**  
各段階で認知的な課題が根本的に異なるため、その段階に最適化されたUIを提供する必要があります。

---

### トリガー2: ホーム画面を開いたとき
アプリを起動してホーム画面を開いた瞬間に、「今やるべき最優先タスク1件」を目立つ形で表示します。

**なぜこのタイミングで変えるのか:**  
起動直後の数秒が最も意思決定しやすいタイミングです。この瞬間に「何をするか」を明確に示すことで、迷いを減らして着手率を高めます。

---

## 4. 各ステージの画面構成（詳細）

### 4.1 実態把握ステージ (capture)

**画面レイアウト:** 1カラム（縦長の単純構成）

**固定要素:**
- `concern_paragraph`: 最初の自由入力欄（段落形式のテキストエリア）
  - ここは毎回固定です。心理的ハードルを下げるため、まず自由に書き出せる場所を提供します。

**動的要素:**
- `intake_questionnaire`: 問診票形式の選択式質問（ラジオボタンまたはセレクトボックス）
  - ユーザーが入力した関心事の内容に応じて、LLMが生成する質問が変わります
  - 例: 「卒業研究」と入力した場合 → 「現在どの段階ですか？」「指導教員との関係は？」など
  - 例: 「ジム再開」と入力した場合 → 「以前の運動習慣は？」「今の障壁は何ですか？」など

**なぜこの構成か:**
- 最初は自由に書ける → 着手ハードルを下げる
- その直後に構造化質問 → 思考を多面的に掘り下げる
- 固定UIとの差: 同じ選択式UIでも、毎回トピックに最適化された質問が出る

---

### 4.2 方針立案ステージ (plan)

**画面レイアウト:** 2カラム（左右に情報を配置）

**3つのUI要素（すべて提供、ユーザーが選択可能）:**

#### ① 戦略ピッカー (strategy_picker)
- 「情報整理」「具体行動」「計画・戦略」の3つから選択
- 各選択肢には**プレビュー情報**が表示される
  - `next3`: 次の3ステップ（例: 「1. 論文を5本読む 2. 実験計画を立てる 3. 教授に相談」）
  - `estimate`: 見積時間（例: 「合計4時間」）
  - `expected_gain`: 期待効果（例: 「研究の全体像が明確になる」）

#### ② トレードオフ・スライダー (tradeoff_slider)
- 2つの軸（速度 vs 質）をスライダーで調整
- スライダーを動かすと、リアルタイムで戦略案が更新される
- 例: 速度を最大にすると「とにかく手を動かす」系の戦略が表示され、質を最大にすると「じっくり調べる」系の戦略に変わる

#### ③ 反実仮想トグル (counterfactual_toggles)
- 制約条件チップ（初期値: 「時間30分のみ」「締切未確定」「集中度低」）
- チップをON/OFFすると、その条件下での戦略候補が即座に再生成される
- 例: 「時間30分のみ」をONにすると、30分で完結する小粒な戦略が提示される

**再生成のタイミング:**
- ユーザーがスライダーやトグルを操作すると、300ミリ秒のデバウンス後に再生成
- なぜ300ms: 連続操作中は無駄な再生成を避け、操作が落ち着いたタイミングで更新

**なぜこの構成か（固定UIとの最大差別化ポイント）:**
- 固定UIでは選択肢が決まっているが、動的UIでは**操作するたびに戦略候補が変化**
- ユーザーは自分の条件に合わせてリアルタイムに戦略をカスタマイズできる
- 意思決定の質と納得感が高まり、下流の着手率向上につながる

---

### 4.3 細分化ステージ (breakdown)

**画面レイアウト:** 2カラム

**主要素:**
- `prioritized_checklist`: 並べ替え可能なチェックリスト
  - 各アイテムには `title`（タスク名）、`duration`（所要時間）、`priority`（優先度バッジ）が表示
  - ドラッグ&ドロップで順番を変更可能
  - 優先度バッジは色と数字で視覚的に強調（後述のサリエンシーシステム）

**なぜこの構成か:**
- 「次の一歩」が明確に可視化される
- 自分で順序を調整できることで、実行のコミットメントが高まる
- チェックリストという親しみやすいUIで、着手の心理的障壁を下げる

---

## 5. 推奨タスクの選出ロジック

### 5.1 いつ実行されるか
ホーム画面を開いたとき（`home.opened` イベント）に、すべてのタスクを評価して最優先の1件を選出します。

---

### 5.2 スコア計算式

```
最終スコア = 0.4 × 重要度 + 0.3 × 緊急度 + 0.2 × 陳腐化度 + 0.1 × 状況適合度
```

**なぜこの重み配分か:**
- **重要度 40%**: 長期的な価値を最重視（短期の雑務に流されない）
- **緊急度 30%**: 締切圧にも反応するが、重要度より少し軽く（バランス）
- **陳腐化度 20%**: 放置されたタスクを再浮上させる（停滞防止）
- **状況適合度 10%**: センサー推定に誤差があるため控えめに（安全策）

---

### 5.3 各要素の計算方法

#### 重要度 (importance)
- **入力**: ユーザーが選択した3段階（低/中/高）
- **数値化**: 低=0.33、中=0.67、高=1.0

**なぜ3段階か:**
- 5段階や10段階だと選択に迷い、入力負荷が高い
- 3段階なら直感的に判断でき、かつ十分な差別化が可能

---

#### 緊急度 (urgency)
- **計算式**: `1 - logistic(締切までの時間, 基準=48時間, 急峻度=0.1)`
- **意味**: 締切が近いほど高スコア、48時間を境に急激に上昇

**なぜ48時間が基準か:**
- 1日（24h）だと短すぎて事前準備が間に合わない
- 3日（72h）だと長すぎて緊急感が薄れる
- 2日（48h）が「そろそろ本気で取り組むべき」という感覚に合致

**ロジスティック関数を使う理由:**
- 線形では締切直前の変化が小さすぎる
- ロジスティックなら「境界付近で急激に変化」を表現できる

---

#### 陳腐化度 (staleness)
- **計算式**: `logistic(最終更新からの日数, 基準=3日, 急峻度=1.5)`
- **意味**: 放置期間が長いほど高スコア、3日を境に上昇

**なぜ3日が基準か:**
- 1〜2日の放置は正常範囲（他のタスクを優先しているだけ）
- 3日以上放置は「忘れている」「後回しにしすぎ」の可能性が高い
- 再浮上させてユーザーに思い出させる

---

#### 状況適合度 (contextFit)
- **計算式**: 以下の3要素を加算（上限1.0）
  - 時間帯が一致: +0.2
  - 場所カテゴリが一致: +0.3
  - 利用可能時間 ≥ 見積時間: +0.5

**なぜこの配分か:**
- **時間が足りる（+0.5）**: 最重要。時間がないタスクを推しても着手不可能
- **場所が合う（+0.3）**: 次点。「自宅専用タスク」を外出先で推すのは無意味
- **時間帯が合う（+0.2）**: 補助。「朝やるべきこと」を夜推すのは効率が悪い

**なぜ状況適合度の重みが10%と低いか:**
- センサーデータ（位置情報、時刻）の推定精度に限界がある
- 誤検出で重要タスクが埋もれるリスクを避ける
- 初期は控えめにし、精度向上後に重みを増やす余地を残す

---

### 5.4 ゲーティング（表示形態の切替）

スコアで順位を決めた後、「今この瞬間に実行可能か」を判定して表示形態を変えます。

```
if (利用可能時間 ≥ タスク見積時間)
  → 本体タスクカードを表示

else if (利用可能時間 ≥ 10分 AND マイクロステップが存在)
  → マイクロステップカードを表示

else
  → 準備ステップカードを表示
```

**各カードの意味:**
- **本体タスクカード**: タスク全体を今すぐ始められる
- **マイクロステップカード**: タスクの一部（10分で完結する小さな1歩）だけ今できる
- **準備ステップカード**: 今はタスク本体に着手できないが、準備行動（資料収集、環境セットアップなど）ならできる

**なぜこの3段階か:**
- 時間が足りないからと「何も表示しない」のは最悪（着手機会を逃す）
- 「今できる何か」を必ず提示することで、少しでも前進させる
- 小さな着手の積み重ねが、最終的な完了率を高める

**なぜ10分がマイクロステップの基準か:**
- 5分: 短すぎて意味のある作業ができない
- 15分: 空き時間が15分あることは稀
- 10分: スキマ時間として現実的で、かつ1つの小タスクを完結できる長さ

---

## 6. 視覚的な強調（サリエンシーシステム）

### 6.1 サリエンシーレベル（4段階）

| レベル | 名前 | 背景色 | フォント | 影 | アイコン | アニメ | いつ使うか |
|-------|------|--------|---------|-----|---------|---------|-----------|
| **0** | base | neutral | 通常 | なし | - | - | 普通のタスク |
| **1** | emphasis | brand-50 | 中 | 薄い | - | - | やや推奨 |
| **2** | primary | brand-100 | 大 | 中 | - | - | **最推奨（標準）** |
| **3** | urgent | danger-100 | 大 | 強い | 警告 | 高速パルス | **緊急（稀）** |

---

### 6.2 運用ルール

**基本:**
- ホーム画面の推奨タスクは常に **レベル2 (primary)** で表示

**例外:**
- 締切まで24時間未満 **かつ** 重要度が高 (≥0.67) の場合のみ **レベル3 (urgent)** に昇格

**なぜこのルールか:**
- レベル3は本当に緊急のときだけ使う（多用すると慣れて効果が薄れる）
- 「重要かつ締切直前」という2条件を満たす場合のみ最大強調
- 通常は安定したレベル2で提示し、視覚的な疲労を避ける

---

### 6.3 トークン化の理由

**なぜ色や余白をトークンで固定するのか:**
- LLMに自由に見た目を決めさせると、毎回異なるスタイルになり一貫性が失われる
- 固定パレット（トークン）だけを使うことで、実験結果の再現性を確保
- A/Bテストで「動的UI vs 固定UI」を比較する際、見た目のブレが測定誤差にならない

---

## 7. 実装: 軽量DSL（Domain Specific Language）

### 7.1 DSLとは何か
UIの仕様をJSON形式で記述したもの。このDSLをフロントエンドが読み取って画面を生成します。

**なぜDSLを使うのか（Jellyの設計思想）:**
- 仕様とコードを分離することで、仕様変更が容易
- LLMは「DSLの生成」に集中し、UIコンポーネントの実装詳細を知らなくて良い
- バージョン管理が明確（DSL v0.5、v0.6...と進化を追跡できる）

参考: この設計はJellyの仕様ベース生成パイプラインに準拠しています。[arXiv, 2025](https://arxiv.org/html/2503.04084v1)

---

### 7.2 DSL全体像（v0.5）

```json
{
  "version": "0.5",
  "appState": { "stage": "capture" },
  "defaults": { "estimate_min_chunk": 10 },
  
  "scales": {
    "importance": { "low": 0.33, "medium": 0.67, "high": 1.0 },
    "staleness": {
      "norm": "logistic",
      "input": "days_since_last_touch",
      "mid_days": 3,
      "k": 1.5,
      "cap": 1.0
    }
  },
  
  "tokens": {
    "saliency": {
      "0": { "bg": "neutral", "font": "base", "elev": 0 },
      "1": { "bg": "brand-50", "font": "md", "elev": 1 },
      "2": { "bg": "brand-100", "font": "lg", "elev": 2 },
      "3": {
        "bg": "danger-100",
        "font": "lg",
        "elev": 3,
        "icon": "warning",
        "anim": "pulse-fast"
      }
    }
  },
  
  "rules": [
    {
      "when": { "app.stage": "capture" },
      "view": {
        "layout": "singleColumn",
        "widgets": ["concern_paragraph", "intake_questionnaire"]
      }
    },
    {
      "when": { "app.stage": "plan" },
      "view": {
        "layout": "twoColumn",
        "widgets": [
          "strategy_picker",
          "tradeoff_slider",
          "counterfactual_toggles"
        ],
        "regen": { "debounce_ms": 300 }
      }
    },
    {
      "when": { "app.stage": "breakdown" },
      "view": {
        "layout": "twoColumn",
        "widgets": ["prioritized_checklist"]
      }
    },
    {
      "when": { "event": "home.opened" },
      "precompute": [
        {
          "let": "stalenessN",
          "expr": "logistic(days_since_last_touch, mid=3, k=1.5)"
        },
        {
          "let": "urgencyN",
          "expr": "1 - logistic(due_in_hours, mid=48, k=0.1)"
        },
        {
          "let": "contextFitN",
          "expr": "min(1, (match_time_of_day?0.2:0) + (match_location_category?0.3:0) + (available_time>=estimate?0.5:0))"
        },
        {
          "let": "score",
          "expr": "0.4*importance + 0.3*urgencyN + 0.2*stalenessN + 0.1*contextFitN"
        }
      ],
      "recommendation": {
        "source": "tasks",
        "score": "score",
        "gating": [
          {
            "if": "available_time >= estimate",
            "then": "task_card"
          },
          {
            "elif": "available_time >= estimate_min_chunk && has_independent_micro_step == true",
            "then": "micro_step_card"
          },
          {
            "else": "prepare_step_card"
          }
        ],
        "take": 1,
        "presentAs": { "component": "task_card" },
        "saliencyRule": "if(due_in_hours<24 && importance>=0.67, 3, 2)"
      }
    }
  ],
  
  "components": {
    "concern_paragraph": {
      "type": "string",
      "render": "paragraph",
      "editable": true,
      "function": "display"
    },
    "intake_questionnaire": {
      "type": "array",
      "render": "expanded",
      "item": { "type": "string", "render": "radio" },
      "editable": true
    },
    "strategy_picker": {
      "type": "string",
      "render": "category",
      "categories": ["情報整理", "具体行動", "計画・戦略"],
      "editable": true,
      "function": "display",
      "preview": ["next3", "estimate", "expected_gain"]
    },
    "tradeoff_slider": {
      "type": "DICT",
      "render": "custom",
      "axes": ["speed", "quality"]
    },
    "counterfactual_toggles": {
      "type": "array",
      "render": "expanded",
      "item": { "type": "string", "render": "shortText" },
      "default": ["時間30分のみ", "締切未確定", "集中度低"]
    },
    "prioritized_checklist": {
      "type": "array",
      "render": "expanded",
      "item": {
        "type": "__TASK_STEP__",
        "thumbnail": ["title", "duration", "priority"]
      },
      "reorderable": true,
      "badges": ["priority"]
    },
    "task_card": {
      "type": "__TASK__",
      "thumbnail": ["title", "estimate", "due_in_hours"],
      "variant": { "saliency": [0, 1, 2, 3] }
    },
    "micro_step_card": {
      "type": "__TASK_STEP__",
      "thumbnail": ["title", "duration"]
    },
    "prepare_step_card": {
      "type": "__TASK_STEP__",
      "thumbnail": ["title", "duration"]
    }
  },
  
  "micro_step_policy": {
    "max_duration_ref": "estimate_min_chunk",
    "independent_required": true,
    "fallback": "prepare_step"
  },
  
  "telemetry": {
    "events": [
      "stage.enter",
      "stage.exit",
      "home.recommendation.shown",
      "cta.action_report.clicked"
    ]
  }
}
```

---

## 8. API設計（2つのエンドポイント）

### 8.1 UI生成API

**エンドポイント:** `POST /v1/ui/generate`

**入力:**
```json
{
  "appState": { "stage": "plan" },
  "context": {
    "concernText": "卒業研究が進まない",
    "factors": {
      "time_of_day": "morning",
      "location_category": "home",
      "available_time": 60
    }
  }
}
```

**出力:**
上記のDSL（またはDSL差分）

**役割:**
- 現在のステージとコンテキストに基づいて、適切なUI仕様を返す
- LLMは「質問文」「戦略案」などの内容を生成し、DSLに埋め込む

---

### 8.2 タスク推奨API

**エンドポイント:** `POST /v1/score/rank`

**入力:**
```json
{
  "available_time": 30,
  "factors": {
    "time_of_day": "evening",
    "location_category": "home"
  },
  "tasks": [
    {
      "id": "T1",
      "importance": 0.67,
      "urgency": 0.8,
      "staleness": 0.4,
      "contextFit": 0.6,
      "estimate": 45,
      "estimate_min_chunk": 10,
      "due_in_hours": 12,
      "has_independent_micro_step": true
    }
  ]
}
```

**出力:**
```json
{
  "recommendation": {
    "taskId": "T1",
    "variant": "micro_step_card",
    "saliency": 3,
    "score": 0.67
  }
}
```

**役割:**
- すべてのタスクをスコアリング
- ゲーティングルールを適用して表示形態を決定
- サリエンシーレベルを計算

**なぜAPIを分離するのか:**
- UIとスコアリングを疎結合にすることで、それぞれ独立して改善可能
- A/Bテストでスコア計算式だけを変更する、といった柔軟な実験が可能

---

## 9. 計測とKPI

### 9.1 第一指標: 着手率

**定義:**
```
着手率 = 「行動報告」ボタンをタップした回数 / 推奨タスクを表示した回数
```

**計測方法:**
1. `home.recommendation.shown` イベント: 推奨タスクを表示したとき
2. `cta.action_report.clicked` イベント: 行動報告ボタンをタップしたとき
3. 同一セッション内でイベントペアを追跡

**なぜこれを第一指標にするのか:**
- MVP要件書で定義された最重要指標
- 「UIを見た → 実際に行動した」という因果関係が明確
- 短期間（1週間）でも測定可能

---

### 9.2 補助指標

- **ステージ別滞在時間**: どのステージで詰まっているかを診断
- **マイクロステップ提示率**: ゲーティングがどれくらい発動しているか
- **サリエンシー別クリック率**: レベル2 vs レベル3の効果差
- **方針立案UIの使用率**: 3種類のUIのうちどれが最も使われているか

---

### 9.3 A/Bテスト設計

**条件:**
- A群: 動的UI（この仕様で実装）
- B群: 固定UI（同じ情報を静的デザインで表示）

**比較指標:**
- 着手率の差
- ステージ完了率の差
- 主観評価（頭のスッキリ度）

---

## 10. 受け入れテスト（最小ケース）

実装が正しく動作していることを確認するための5つのテストケース:

| # | 条件 | 期待される結果 |
|---|------|--------------|
| 1 | available_time=30分、estimate=20分 | 本体タスクカード、サリエンシー=2 |
| 2 | available_time=10分、estimate=25分、マイクロステップあり | マイクロステップカード、サリエンシー=2 |
| 3 | available_time=5分、estimate_min_chunk=10分 | 準備ステップカード、サリエンシー=2 |
| 4 | due_in_hours=8、importance=高 | サリエンシー=3（緊急表示） |
| 5 | 最終更新7日前のタスク vs 1日前のタスク | 7日前のタスクの方がスコアが高い |

---

## 11. セキュリティとプライバシー

### 11.1 データの扱い

| データ種別 | 例 | サーバー送信 | 理由 |
|-----------|---|------------|------|
| **ユーザー明示入力** | 関心事のテキスト、選択した戦略 | ○ そのまま | LLMが内容を理解して適切なUIを生成するために必要 |
| **自動取得factors** | 位置情報、時刻、利用可能時間 | ○ 抽象化 | `home/work/other`, `morning/afternoon/evening` など抽象化して送信 |
| **個人特定情報** | GPS座標、カレンダーの具体的予定 | × ローカルのみ | プライバシーリスクを最小化 |

### 11.2 通信セキュリティ
- すべてのAPI通信はTLS暗号化必須
- ユーザーIDはハッシュ化して匿名化

---

## 12. 今後の拡張（実験後の検討項目）

### 短期（実験結果を見てから決定）
- 方針立案UIの3要素のうち、どれを残すか
- contextFitの重みを調整（精度向上後に10% → 15%など）
- サリエンシー2と3の視覚的差分の最適化

### 中期（ユーザーフィードバック後）
- マイクロステップの自動抽出精度向上
- 新しいfactorsの追加（motion, calendar統合など）
- スコア計算式の機械学習ベース最適化

### 長期（研究発展の方向性）
- 複数タスクの同時推奨
- タスク間の依存関係の考慮
- ユーザー固有のスコア重み学習

---

## 13. まとめ: この仕様の3つのポイント

### ① 測定可能
- すべての決定が明示的なルールとして記述されている
- A/Bテストで「何が効いたか」を因果的に解釈できる
- 第一指標（着手率）との関係が追跡可能

### ② 安定的
- トリガーで決定的にUIを切り替えるため、再現性が高い
- トークン化により視覚的なブレがない
- LLMの役割を内容生成に限定し、UI構造は制御下に置く

### ③ 拡張可能
- DSLバージョン管理により、段階的な改善が容易
- APIの疎結合により、スコアリングやUI生成を独立して改良可能
- 実験結果に基づいて重みや閾値を調整する余地が明確

---

**参考文献:**
- Cao, Y., Jiang, P., & Xia, H. (2025). Generative and Malleable User Interfaces with Generative and Evolving Task-Driven Data Model. CHI 2025. https://arxiv.org/html/2503.04084v1

---

**文書バージョン:** v0.5  
**最終更新:** 2025年10月11日  
**作成者:** 研究プロジェクトチーム
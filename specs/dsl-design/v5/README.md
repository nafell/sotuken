# DSL v5 - Plan統合アーキテクチャ

**Version**: 5.0
**Date**: 2025-12-08
**Status**: Draft

---

## 概要

DSL v5は、planフェーズの1ページ化とWidget-to-Widget Reactivity（W2WR）の同一ページ内動作を実現するための仕様拡張である。

## v4からの主要変更点

| 観点 | v4 | v5 |
|------|-----|-----|
| Planフェーズ構造 | 4ステージ別ページ（diverge/organize/converge/summary） | 3セクション統合1ページ + summaryページ |
| UISpec stage | `'diverge' \| 'organize' \| 'converge' \| 'summary'` | `'plan' \| 'summary'` を追加 |
| UISpec構造 | `widgets: WidgetSpec[]` | `sections: { diverge, organize, converge }` |
| W2WR動作 | ステージ間データ引き継ぎ（遅延） | 同一ページ内リアルタイム連携 |
| LLM呼び出し | ステージごとにORS+UISpec生成 | Plan全体で1回のORS+UISpec生成 |

## ドキュメント構成

| ファイル | 内容 |
|---------|------|
| [requirements.md](./requirements.md) | v5要件定義書 |
| [DSL-Spec-v5.0.md](./DSL-Spec-v5.0.md) | DSL仕様書v5 |

## 設計原則

1. **W2WR検証優先**: 6ケースのW2WRパターンを同一ページ内で検証可能にする
2. **後方互換性**: v4のsummaryステージは維持、旧データは閲覧不可（新形式のみ対応）
3. **Jelly準拠維持**: 3層DSL構造、ORS/DpG/ReactiveBindingの責務分離は継承

## アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│ Planフェーズ（1ページ）                                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ divergeセクション                                        │    │
│  │   Widget群（brainstorm_cards, emotion_palette, etc.）    │    │
│  └─────────────────────────────────────────────────────────┘    │
│                    ↓ W2WR (realtime/debounced)                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ organizeセクション                                       │    │
│  │   Widget群（card_sorting, timeline_slider, etc.）        │    │
│  └─────────────────────────────────────────────────────────┘    │
│                    ↓ W2WR (realtime/debounced)                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ convergeセクション                                       │    │
│  │   Widget群（priority_slider_grid, tradeoff_balance, etc.）│   │
│  └─────────────────────────────────────────────────────────┘    │
├─────────────────────────────────────────────────────────────────┤
│                        [次へ（まとめ）]                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Summaryフェーズ（別ページ）                                      │
│   structured_summary Widget                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 関連ドキュメント

- [DSL v4 仕様書](../v4/DSL-Spec-v4.0.md)
- [W2WRテストケース設計](../../discussions/DSLv3_expert_cases.md)

---

## 変更履歴

| Version | Date | Changes |
|---------|------|---------|
| 5.0 | 2025-12-08 | 初版作成 |

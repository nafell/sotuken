# 動的UI問題点調査レポート

**作成日**: 2025年10月20日
**調査者**: Phase 3実装チーム

---

## 📊 調査結果サマリー

動的UIシステムは基本的な動作は確認できているものの、ユーザーに提供できるレベルには到達していない。
主な問題は以下の3カテゴリに分類される：

1. **機能的問題** - UIが正しく生成・表示されない
2. **ユーザビリティ問題** - UIの理解性・操作性が低い
3. **堅牢性問題** - エラー処理やフォールバックが不十分

---

## 🔍 詳細な問題分析

### 1. 機能的問題

#### 1.1 planフェーズのカスタムウィジェット問題

**症状**: planフェーズでblankに近い画面が表示される

**原因分析**:
- `UISpecGenerator.ts`のプロンプト（155-207行目）でカスタムウィジェット（`strategy_preview_picker`, `tradeoff_slider`等）の使用を指示
- しかしLLMがこれらのウィジェットを正しく生成できていない可能性が高い
- UIRendererでウィジェットパスが見つからずフォールバック表示になる

**コード箇所**:
```typescript
// UIRenderer.tsx:92-98行目
const renderWidget = (entityPath: string, index: number) => {
  const renderSpec = uiSpec.mappings[entityPath];

  if (!renderSpec) {
    console.warn(`No render spec found for: ${entityPath}`);
    return null;  // ここで何も表示されなくなる
  }
```

#### 1.2 breakdownフェーズの暫定UI問題

**症状**: breakdownフェーズが完全に暫定UIで実装されている

**現状**:
- `BreakdownScreen.tsx`では固定のフォールバックアクションを使用（34-52行目）
- `extractActionsFromDSL`関数が未実装または正しく動作していない
- 動的UIは生成されるが、そこからアクション抽出ができていない

#### 1.3 layout.sectionsのwidgets欠落問題

**症状**: LLM生成時にsectionsのwidgetsフィールドが欠落することがある

**対策済み箇所**:
- `UISpecGenerator.ts:391-414`で自動補完処理を実装
- `UIRenderer.tsx:164-171`で警告ログ出力

---

### 2. ユーザビリティ問題

#### 2.1 表示文字列の問題

**症状**: UIに表示される文字列がユーザーフレンドリーでない

**具体例**:
```typescript
// UIRenderer.tsx:125-127行目
// エンティティパスをそのまま表示している
const label = entityPath.split('.').pop() || entityPath;
// 例: "CONCERN.concernText" → "concernText"と表示される
```

**問題点**:
- 英語の技術用語がそのまま表示される
- 日本語化されていない
- ユーザーが何を入力すべきか分からない

#### 2.2 プレースホルダー・ヒントの不足

**症状**: 入力欄に適切なプレースホルダーやヒントがない

**現状**:
- UISpecGeneratorのプロンプトでplaceholder指定はあるが、実際の値が不適切
- 例: "..." のような意味のないプレースホルダー

#### 2.3 エラーメッセージの不親切さ

**症状**: エラー時の表示がユーザーに分かりにくい

```typescript
// UIRenderer.tsx:193-200行目
// エラー時のメッセージが技術的すぎる
<p className="text-yellow-800 font-semibold">
  UIを生成できません：必要なデータが不足しています
</p>
```

---

### 3. 堅牢性問題

#### 3.1 バリデーション不足

**症状**: 不完全なUISpecでもレンダリングを試みて失敗する

**問題箇所**:
- `UISpecValidator.ts`でバリデーションはあるが、警告レベルで止まっている
- エラーでも処理を継続してしまう

#### 3.2 フォールバック処理の不完全さ

**症状**: エラー時のフォールバックUIが実装されていない

**必要な実装**:
- ウィジェット単位のフォールバック（UIRenderer.tsx:115-122は未実装コンポーネントの表示のみ）
- 画面全体のフォールバックUI
- 静的UIへの切り替え機能

#### 3.3 エラーログの不足

**症状**: デバッグに必要な情報が記録されていない

**現状**:
- console.warnのみでIndexedDBへの永続化なし
- エラーの頻度や傾向が分析できない

---

## 🎯 問題の優先度マップ

### 緊急度：高 × 影響度：高
1. **planフェーズの空白画面問題**
   - ユーザー体験を著しく損なう
   - Phase 3で最優先で対処すべき

2. **フォールバックUI未実装**
   - エラー時にユーザーが操作不能になる

### 緊急度：高 × 影響度：中
3. **表示文字列の日本語化**
   - 日本人ユーザーが対象のため必須

4. **breakdownフェーズの暫定UI**
   - 機能は動くが品質が低い

### 緊急度：中 × 影響度：高
5. **エラーログ強化**
   - 長期的な品質改善に必要

6. **バリデーション強化**
   - 堅牢性向上に必要

---

## 💡 根本原因の分析

### 複数仕様にまたがる問題

現在の問題は以下の要素が複雑に絡み合っている：

1. **DSL仕様の曖昧さ**
   - カスタムウィジェットの仕様が不明確
   - LLMが理解しにくい

2. **プロンプトの品質**
   - 指示が長すぎて要点が伝わらない
   - 具体例が不足

3. **Rule-based Rendererの限界**
   - ComponentMapperがカスタムウィジェットを正しく処理できない
   - DynamicWidgetへの委譲が機能していない可能性

4. **実装の不完全さ**
   - カスタムウィジェットコンポーネントが最小限の実装
   - propsの受け渡しが不完全

---

## 📋 改善提案（概要）

### Phase 3で対処すべき項目

1. **即効性のある改善**
   - UIRendererのフォールバック処理強化
   - 表示文字列のハードコード日本語化
   - エラーログのIndexedDB記録

2. **中期的改善**
   - UISpecGeneratorのプロンプト改善
   - fillDefaultsメソッドの拡充
   - バリデーション強化

3. **根本的改善（要議論）**
   - カスタムウィジェットの廃止/簡略化検討
   - 静的UIとのハイブリッド方式
   - プロンプトの大幅な簡略化

---

## 🔄 次のアクション

1. このレポートを基に改善方針を議論
2. 優先度の高い問題から順次対処
3. 各改善のテストケース作成
4. Phase 3完了に向けた実装開始
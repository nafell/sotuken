# Phase 3準備: 既存機能の問題点棚卸し

**作成日**: 2025年10月19日
**目的**: Phase 3開始前に既存機能の問題点を洗い出し、優先度付けする
**方針**: 動的UI生成のユーザビリティと堅牢性向上を重視

---

## 🔴 **高優先度**: Phase 3で必ず対応

### 1. TypeScriptビルドエラー（約25件）

**現状**: `bun run build`でTypeScriptエラーが発生

**影響範囲**:
- Phase 0-1の既存ファイル
- 新規実装には影響なし（開発サーバーは動作）

**該当ファイル**:
- `src/components/ActionReportModal.tsx`
- `src/components/DatabaseTest.tsx`
- `src/components/FactorsTest.tsx`
- `src/components/screens/ApproachScreen.tsx`
- `src/components/ui/widgets/SummaryListWidget.tsx`
- `src/services/api/ApiService.ts`
- `src/services/context/CapacitorIntegration.ts`
- `src/services/database/localDB.ts`
- `src/services/session/SessionManager.ts`
- `src/types/database.ts`

**Phase 3タスク**:
1. **調査フェーズ（30分）**
   - 各エラーの内容を分類
   - 修正の難易度と影響範囲を評価
   - 修正すべきか放置すべきか判断

2. **判断基準**:
   - ✅ 修正する: 実行時エラーの原因になる、型安全性が著しく低下
   - ❌ 放置する: 未使用変数の警告、影響範囲が限定的

3. **修正実施（判断次第）**
   - 高優先度エラーのみ修正
   - 低優先度は`// @ts-ignore`で一時対応

---

### 2. UIRenderer堅牢性の問題

**現状**: LLM出力の不完全性に対する防御的処理が不十分

**既知の問題**:
- ✅ `section.widgets`のundefined対策（Phase 2 Step 3で対応済み）
- ⚠️ その他のフィールド欠落への対応が不完全

**Phase 3タスク**:
1. **網羅的な防御的処理の追加**
   - `mappings`の各フィールドチェック
   - `layout`の各プロパティチェック
   - `widgets`の各プロパティチェック

2. **UISpecValidatorの拡充**
   - バリデーションルールの追加
   - エラーメッセージの改善

3. **fillDefaultsメソッドの拡充**
   - `fillMappingsDefaults`の拡張
   - `fillLayoutDefaults`の拡張（Phase 2 Step 3で実装済み）
   - `fillWidgetsDefaults`の新規実装

---

### 3. エラーハンドリング・フォールバック機構

**現状**: エラー発生時の復旧処理が不十分

**問題点**:
- LLM生成失敗時のフォールバックUIが未実装
- ネットワークエラー時の処理が不十分
- エラーログの記録が不完全

**Phase 3タスク**:
1. **フォールバックUI実装**
   - 静的テンプレートの準備
   - LLM失敗時の自動切り替え

2. **エラーハンドリング強化**
   - try-catchの網羅的な配置
   - ユーザーフレンドリーなエラーメッセージ

3. **エラーログ記録**
   - エラーイベントの記録
   - サーバーへの送信

---

### 4. ユーザビリティの問題

**現状**: 動的UI生成が動作するが、UXが粗い

**問題点**:
- ローディング表示が不十分（約10秒待たされる）
- エラー発生時のフィードバックが不親切
- UI生成の進捗が分からない

**Phase 3タスク**:
1. **ローディングUX改善**
   - スケルトンスクリーン実装
   - 進捗バーの表示
   - 推定残り時間の表示

2. **エラーフィードバック改善**
   - エラー内容の分かりやすい説明
   - リトライボタンの追加
   - サポート情報の表示

3. **UX調査と設計議論**
   - ユーザーテストの実施
   - 改善案の議論
   - プロトタイプ作成

---

## 🟡 **中優先度**: Phase 3で可能なら対応

### 5. IndexedDB複合インデックスの最適化

**現状**: クエリパフォーマンスが最適化されていない箇所がある

**問題点**:
- 一部のクエリで`toArray()`後にfilterを使用
- 複合インデックスが活用されていない

**Phase 3タスク**:
1. **パフォーマンス測定**
   - クエリ実行時間の計測
   - ボトルネック特定

2. **インデックス最適化**
   - 複合インデックスの追加
   - クエリの書き換え

---

### 6. 新規性レベル制御の精度

**現状**: 新規性レベル（low/med/high）の制御が粗い

**問題点**:
- 新規性の定義が曖昧
- ユーザーの好みが反映されない

**Phase 3タスク**:
1. **新規性の定義明確化**
   - low: 変化少ない
   - med: 適度な変化
   - high: 大きな変化

2. **パラメータ調整**
   - プロンプトの改善
   - サンプル生成での検証

---

### 7. イベントログの記録漏れ

**現状**: 一部のユーザーアクションでイベント記録が漏れている可能性

**問題点**:
- イベント記録の網羅性が未検証
- 記録タイミングの一貫性がない

**Phase 3タスク**:
1. **イベント記録の網羅性検証**
   - 全画面遷移のイベント記録確認
   - 漏れている箇所の特定

2. **記録タイミングの統一**
   - イベント記録のガイドライン作成
   - 一貫性のある実装

---

## 🟢 **低優先度**: Phase 4以降で対応

### 8. A/Bテスト機構の根本的再設計

**現状**: 緊急対応で全ユーザー動的UI固定

**Phase 4で対応**:
- データベース永続化実装
- 全ユーザー管理API実装
- 状態同期機構の再設計

---

### 9. 認証・認可機構

**現状**: 管理者認証が未実装

**Phase 4で対応**:
- 管理者認証実装
- セッション管理
- 権限管理

---

### 10. AdminDashboardの機能拡充

**現状**: 基本的なメトリクス表示のみ

**Phase 4で対応**:
- Chart.jsによる高度なグラフ
- リアルタイム更新
- CSV出力機能

---

## 📊 Phase 3優先度マトリクス

| 問題 | 影響度 | 緊急度 | 修正コスト | 優先度 |
|------|--------|--------|-----------|--------|
| 1. ビルドエラー | 高 | 高 | 中 | 🔴 高 |
| 2. UIRenderer堅牢性 | 高 | 高 | 中 | 🔴 高 |
| 3. エラーハンドリング | 高 | 高 | 高 | 🔴 高 |
| 4. ユーザビリティ | 高 | 高 | 高 | 🔴 高 |
| 5. IndexedDB最適化 | 中 | 低 | 中 | 🟡 中 |
| 6. 新規性制御 | 中 | 中 | 低 | 🟡 中 |
| 7. イベントログ漏れ | 中 | 中 | 低 | 🟡 中 |
| 8. A/Bテスト | 低 | 低 | 高 | 🟢 低 |
| 9. 認証・認可 | 低 | 低 | 高 | 🟢 低 |
| 10. AdminDashboard | 低 | 低 | 中 | 🟢 低 |

---

## 🎯 Phase 3での対応方針

### 必須タスク（高優先度）
1. **TypeScriptビルドエラー調査・修正判断**（30分〜2時間）
2. **UIRenderer堅牢性強化**（2〜3時間）
3. **エラーハンドリング強化**（3〜4時間）
4. **ユーザビリティ改善**（4〜6時間）

### 可能なら実施（中優先度）
5. **IndexedDB最適化**（1〜2時間）
6. **新規性制御調整**（1〜2時間）
7. **イベントログ検証**（1時間）

### Phase 4に先送り（低優先度）
8. A/Bテスト機構再設計
9. 認証・認可機構
10. AdminDashboard機能拡充

---

**次のアクション**: この棚卸しをもとにPhase 3の詳細タスクリストを作成

